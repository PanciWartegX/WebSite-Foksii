<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifikasi Email - Sistem Absensi FOKSI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .verify-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #b71c1c 0%, #d32f2f 100%);
            padding: 20px;
        }
        
        .verify-card {
            background: white;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 100%;
        }
        
        .verify-icon {
            font-size: 5rem;
            margin-bottom: 30px;
        }
        
        .verify-icon.success {
            color: #4caf50;
        }
        
        .verify-icon.warning {
            color: #ff9800;
        }
        
        .verify-icon.error {
            color: #f44336;
        }
        
        .verify-icon.info {
            color: #2196f3;
        }
        
        .verify-card h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        
        .verify-card p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .verify-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }
        
        .verify-details {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
        
        .verify-details h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .verify-details p {
            margin-bottom: 5px;
            color: #666;
            font-size: 0.95rem;
        }
        
        @media (max-width: 768px) {
            .verify-card {
                padding: 30px;
            }
            
            .verify-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="verify-container">
        <div class="verify-card">
            <div class="verify-icon info" id="verifyIcon">
                <i class="fas fa-envelope"></i>
            </div>
            
            <h1 id="verifyTitle">Verifikasi Email</h1>
            
            <p id="verifyMessage">
                Kami telah mengirim email verifikasi ke alamat email Anda. 
                Silakan cek inbox email Anda dan klik link verifikasi untuk mengaktifkan akun.
            </p>
            
            <div class="verify-details" id="emailDetails">
                <!-- Email details will be filled by JavaScript -->
            </div>
            
            <div class="verify-actions">
                <a href="index.html" class="btn btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Ke Halaman Login
                </a>
                <button class="btn btn-secondary" id="resendBtn">
                    <i class="fas fa-redo"></i> Kirim Ulang Email
                </button>
                <button class="btn btn-info" id="helpBtn">
                    <i class="fas fa-question-circle"></i> Butuh Bantuan?
                </button>
            </div>
            
            <div class="timer" style="margin-top: 20px; color: #666; font-size: 0.9rem;">
                <i class="fas fa-clock"></i> 
                <span id="timerText">Dapat mengirim ulang dalam: </span>
                <span id="countdown" style="font-weight: bold;">60 detik</span>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-question-circle"></i> Bantuan Verifikasi Email</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h4>Langkah-langkah Verifikasi:</h4>
                    <ol style="margin-left: 20px; margin-bottom: 20px;">
                        <li>Buka email yang Anda gunakan untuk mendaftar</li>
                        <li>Cari email dari "Sistem Absensi FOKSI"</li>
                        <li>Buka email dan klik link verifikasi</li>
                        <li>Akun Anda akan langsung aktif</li>
                    </ol>
                    
                    <h4>Jika tidak menerima email:</h4>
                    <ul style="margin-left: 20px; margin-bottom: 20px;">
                        <li>Cek folder spam atau junk</li>
                        <li>Pastikan email yang dimasukkan benar</li>
                        <li>Tunggu beberapa menit</li>
                        <li>Klik "Kirim Ulang Email"</li>
                    </ul>
                    
                    <h4>Masih bermasalah?</h4>
                    <p>Hubungi administrator sistem untuk bantuan lebih lanjut.</p>
                    
                    <div class="contact-info" style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <p><strong>Email Admin:</strong> admin@foksi.com</p>
                        <p><strong>Telepon:</strong> (021) 1234-5678</p>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary close-modal">Tutup</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth } from './firebase-config.js';
        import { 
            sendEmailVerification,
            applyActionCode,
            checkActionCode,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { showNotification } from './auth.js';

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const actionCode = urlParams.get('oobCode');
        const mode = urlParams.get('mode');
        const continueUrl = urlParams.get('continueUrl');
        const lang = urlParams.get('lang') || 'id';

        // Elements
        const verifyIcon = document.getElementById('verifyIcon');
        const verifyTitle = document.getElementById('verifyTitle');
        const verifyMessage = document.getElementById('verifyMessage');
        const emailDetails = document.getElementById('emailDetails');
        const resendBtn = document.getElementById('resendBtn');
        const helpBtn = document.getElementById('helpBtn');
        const countdownElement = document.getElementById('countdown');
        const timerText = document.getElementById('timerText');
        const helpModal = document.getElementById('helpModal');
        const closeModalButtons = document.querySelectorAll('.close-modal');

        let userEmail = '';
        let countdown = 60;
        let countdownInterval;

        // Handle email verification from link
        async function handleEmailVerification() {
            if (mode === 'verifyEmail' && actionCode) {
                try {
                    // Show loading state
                    verifyIcon.className = 'verify-icon info';
                    verifyIcon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    verifyTitle.textContent = 'Memproses Verifikasi...';
                    verifyMessage.textContent = 'Sedang memverifikasi email Anda...';

                    // Apply the verification code
                    const info = await checkActionCode(auth, actionCode);
                    userEmail = info.data.email;
                    
                    await applyActionCode(auth, actionCode);

                    // Success
                    verifyIcon.className = 'verify-icon success';
                    verifyIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                    verifyTitle.textContent = 'Email Berhasil Diverifikasi!';
                    verifyMessage.textContent = 'Selamat! Email Anda telah berhasil diverifikasi. Akun Anda sekarang aktif dan siap digunakan.';
                    
                    emailDetails.innerHTML = `
                        <h3>Detail Verifikasi:</h3>
                        <p><strong>Email:</strong> ${userEmail}</p>
                        <p><strong>Status:</strong> <span style="color: #4caf50; font-weight: bold;">Terverifikasi</span></p>
                        <p><strong>Waktu:</strong> ${new Date().toLocaleString('id-ID')}</p>
                    `;

                    showNotification('Email berhasil diverifikasi!', 'success');
                    
                    // Update login button text
                    document.getElementById('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Login Sekarang';

                    // Start countdown for auto-redirect
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 5000);

                } catch (error) {
                    console.error('Email verification error:', error);
                    
                    // Error state
                    verifyIcon.className = 'verify-icon error';
                    verifyIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                    
                    if (error.code === 'auth/invalid-action-code') {
                        verifyTitle.textContent = 'Kode Verifikasi Tidak Valid';
                        verifyMessage.textContent = 'Kode verifikasi tidak valid atau sudah kadaluarsa. Silakan minta email verifikasi baru.';
                    } else if (error.code === 'auth/expired-action-code') {
                        verifyTitle.textContent = 'Kode Verifikasi Kadaluarsa';
                        verifyMessage.textContent = 'Kode verifikasi sudah kadaluarsa. Silakan minta email verifikasi baru.';
                    } else {
                        verifyTitle.textContent = 'Verifikasi Gagal';
                        verifyMessage.textContent = 'Terjadi kesalahan saat memverifikasi email. Silakan coba lagi atau hubungi administrator.';
                    }
                    
                    emailDetails.innerHTML = `
                        <h3>Informasi Error:</h3>
                        <p><strong>Kode Error:</strong> ${error.code}</p>
                        <p><strong>Pesan:</strong> ${error.message}</p>
                    `;
                    
                    showNotification('Verifikasi gagal: ' + error.message, 'error');
                }
            } else {
                // Default state - waiting for verification
                checkAuthState();
            }
        }

        // Check authentication state
        function checkAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userEmail = user.email;
                    
                    emailDetails.innerHTML = `
                        <h3>Informasi Akun:</h3>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Status Verifikasi:</strong> 
                            <span style="color: ${user.emailVerified ? '#4caf50' : '#ff9800'}; font-weight: bold;">
                                ${user.emailVerified ? 'Terverifikasi' : 'Belum Diverifikasi'}
                            </span>
                        </p>
                        <p><strong>ID Pengguna:</strong> ${user.uid.substring(0, 8)}...</p>
                    `;

                    if (user.emailVerified) {
                        verifyIcon.className = 'verify-icon success';
                        verifyIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                        verifyTitle.textContent = 'Email Sudah Diverifikasi';
                        verifyMessage.textContent = 'Email Anda sudah terverifikasi. Akun Anda aktif dan siap digunakan.';
                        resendBtn.style.display = 'none';
                        timerText.style.display = 'none';
                        countdownElement.style.display = 'none';
                    } else {
                        startCountdown();
                    }
                } else {
                    // User not logged in
                    verifyIcon.className = 'verify-icon warning';
                    verifyIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    verifyTitle.textContent = 'Verifikasi Email Diperlukan';
                    verifyMessage.textContent = 'Silakan login terlebih dahulu untuk mengirim ulang email verifikasi.';
                    resendBtn.style.display = 'none';
                    timerText.style.display = 'none';
                    countdownElement.style.display = 'none';
                    
                    emailDetails.innerHTML = `
                        <h3>Informasi:</h3>
                        <p>Anda belum login. Silakan login untuk mengakses fitur verifikasi email.</p>
                    `;
                }
            });
        }

        // Start countdown for resend button
        function startCountdown() {
            resendBtn.disabled = true;
            countdown = 60;
            
            countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = `${countdown} detik`;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = '<i class="fas fa-redo"></i> Kirim Ulang Email';
                    timerText.style.display = 'none';
                    countdownElement.style.display = 'none';
                }
            }, 1000);
        }

        // Resend verification email
        resendBtn.addEventListener('click', async function() {
            try {
                const user = auth.currentUser;
                
                if (!user) {
                    showNotification('Silakan login terlebih dahulu', 'error');
                    return;
                }
                
                if (user.emailVerified) {
                    showNotification('Email sudah terverifikasi', 'info');
                    return;
                }
                
                // Show loading
                resendBtn.disabled = true;
                resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';
                
                await sendEmailVerification(user, {
                    url: window.location.origin + '/verify-email.html',
                    handleCodeInApp: true
                });
                
                showNotification('Email verifikasi telah dikirim ulang!', 'success');
                
                // Reset countdown
                clearInterval(countdownInterval);
                startCountdown();
                
                // Update UI
                verifyMessage.innerHTML = `
                    <p>Email verifikasi telah dikirim ulang ke <strong>${user.email}</strong>.</p>
                    <p>Silakan cek inbox email Anda dan klik link verifikasi.</p>
                    <p><small>Email mungkin masuk ke folder spam jika tidak ditemukan di inbox.</small></p>
                `;
                
            } catch (error) {
                console.error('Resend verification error:', error);
                showNotification('Gagal mengirim ulang email verifikasi: ' + error.message, 'error');
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo"></i> Kirim Ulang Email';
            }
        });

        // Help button
        helpBtn.addEventListener('click', function() {
            helpModal.style.display = 'block';
        });

        // Close modal buttons
        closeModalButtons.forEach(button => {
            button.addEventListener('click', function() {
                helpModal.style.display = 'none';
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            handleEmailVerification();
            
            // Add CSS for spinner
            const style = document.createElement('style');
            style.textContent = `
                .fa-spinner {
                    animation: spin 1s linear infinite;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                .verify-icon .fa-spinner {
                    font-size: 5rem;
                    color: #2196f3;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>